<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic9 Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS --- */
        :root { --primary:#00509d; --dark:#002952; --accent:#ffcc00; --bg:#f2f4f8; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
        body { display:flex; height:100vh; background:var(--bg); overflow:hidden; }

        /* Sidebar */
        .sidebar { width:260px; background:white; border-right:1px solid #ddd; display:flex; flex-direction:column; z-index:100; transition:0.3s; }
        .logo-area { background:black; padding:25px; text-align:center; color:var(--accent); font-weight:800; border-bottom:4px solid var(--primary); }
        .nav-item { padding:16px 25px; color:#555; display:flex; align-items:center; border-bottom:1px solid #f9f9f9; cursor:pointer; }
        .nav-item.active { background:#eef7ff; color:var(--primary); border-left:4px solid var(--primary); }
        .nav-item i { width:25px; margin-right:10px; }
        
        /* Main */
        .main-content { flex:1; display:flex; flex-direction:column; width:100%; }
        .top-header { background:linear-gradient(90deg, var(--primary), var(--dark)); color:white; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; }
        
        .user-pill { background:rgba(255,255,255,0.15); padding:8px 15px; border-radius:50px; border:1px solid rgba(255,255,255,0.2); font-weight:bold; font-size:14px; }

        /* Pages */
        .page { display:none; padding:25px; overflow-y:auto; flex:1; animation:slideUp 0.4s ease; }
        .page.active { display:block; }
        @keyframes slideUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}

        .card { background:white; border-radius:10px; padding:25px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); border-top:4px solid var(--primary); }
        .btn { padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px; }
        input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; outline:none; margin-top:5px; }

        /* Table */
        table { width:100%; border-collapse:collapse; font-size:14px; margin-top:10px; }
        th { background:#f4f4f4; text-align:left; padding:12px; }
        td { padding:12px; border-bottom:1px solid #eee; }
        .status-dot { height:8px; width:8px; border-radius:50%; display:inline-block; margin-right:5px; }
        
        /* Modal */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:white; padding:25px; border-radius:10px; width:90%; max-width:350px; text-align:center; }

        /* Footer */
        .footer { text-align:center; padding:20px; font-size:12px; color:#777; border-top:1px solid #ddd; background:white; }
        .badges { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
        .badge { border:1px solid #ccc; padding:3px 8px; border-radius:4px; font-size:11px; display:flex; align-items:center; gap:5px; }

        /* Mobile */
        @media(max-width:768px) { 
            .sidebar { position:absolute; left:-260px; height:100%; }
            .sidebar.show { left:0; box-shadow:5px 0 20px rgba(0,0,0,0.2); }
            .mobile-toggle { display:block !important; margin-right:15px; font-size:20px; }
        }
        .mobile-toggle { display:none; }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="logo-area">Magic9.pro</div>
        <div class="nav-item active" onclick="nav('user', this)"><i class="fas fa-users"></i> User Management</div>
        <div class="nav-item" onclick="nav('bets', this)"><i class="fas fa-gamepad"></i> Live Betting</div>
        <div class="nav-item" style="margin-top:auto; color:#dc3545;" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>

    <div class="main-content" onclick="closeSidebar(event)">
        <div class="top-header">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
                <h3>Dashboard</h3>
            </div>
            <div class="user-pill" id="headerUser">Connecting...</div>
        </div>

        <div id="page-user" class="page active">
            <div class="card" id="createCard">
                <h3><i class="fas fa-user-plus"></i> Create Downline</h3>
                <form id="createForm">
                    <label>Role</label><select id="newRole"></select>
                    <label style="margin-top:10px">Username</label><input type="text" id="newUsername" required>
                    <label style="margin-top:10px">Password</label><input type="text" id="newPassword" required>
                    <button type="submit" class="btn">Create User</button>
                </form>
            </div>

            <div class="card">
                <h3><i class="fas fa-list"></i> User List</h3>
                <div style="overflow-x:auto">
                    <table id="userTable">
                        <thead><tr><th>Status</th><th>User</th><th>Role</th><th>Chips</th><th>Action</th></tr></thead>
                        <tbody><tr><td colspan="5">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-bets" class="page">
            <div class="card">
                <h3>Live Matches</h3>
                <p style="padding:10px 0;">Betting Module Available for Clients.</p>
            </div>
        </div>

        <div class="footer">
            <div class="badges">
                <div class="badge" style="color:red; border-color:red"><i class="fas fa-ban"></i> 18+ Only</div>
                <div class="badge" style="color:green; border-color:green"><i class="fas fa-shield-alt"></i> Secure</div>
                <div class="badge" style="color:blue; border-color:blue"><i class="fas fa-headset"></i> Support</div>
            </div>
            &copy; 2026 Magic9.pro. All Rights Reserved.
        </div>
    </div>

    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary)">Manage Credits</h3>
            <p style="margin:10px 0; font-size:13px;">User: <b id="modalTargetUser"></b></p>
            <input type="number" id="transferAmount" placeholder="Enter Amount" style="text-align:center; font-size:18px;">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:#dc3545" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="confirmTransfer()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Init
        let currentUser = null;
        let targetReceiverId = null;

        try { currentUser = JSON.parse(sessionStorage.getItem('currentUser')); } catch(e){}
        if(!currentUser) window.location.href = 'login.html';

        init();

        function init() {
            updateHeader();
            setupRoles();
            loadDownline();
        }

        async function updateHeader() {
            try {
                // RESTORED: Localhost URL
                const res = await fetch('/api/user-details', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({id: currentUser.id})
                });
                const data = await res.json();
                if(data.success) {
                    currentUser = data.data;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('headerUser').innerHTML = `${currentUser.username} | <span style="color:#ffcc00">${currentUser.balance}</span>`;
                }
            } catch(e) { document.getElementById('headerUser').innerText = "Offline"; }
        }

        async function loadDownline() {
            const tbody = document.querySelector('#userTable tbody');
            try {
                // RESTORED: Localhost URL
                const res = await fetch('/api/my-users', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({parentId: currentUser.id})
                });
                const data = await res.json();
                tbody.innerHTML = '';
                
                if(data.users.length === 0) { tbody.innerHTML = '<tr><td colspan="5">No users found.</td></tr>'; return; }

                data.users.forEach(u => {
                    const statusColor = u.status === 'Online' ? '#28a745' : '#dc3545';
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="status-dot" style="background:${statusColor}"></span> ${u.status}</td>
                            <td><b>${u.username}</b></td>
                            <td>${u.role}</td>
                            <td style="color:green; font-weight:bold;">${u.balance}</td>
                            <td>
                                <button class="btn" style="padding:5px 10px; margin:0; width:auto; font-size:12px;" onclick="openTransferModal(${u.id}, '${u.username}')">
                                    <i class="fas fa-coins"></i> Give
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="5">Connection Error</td></tr>'; }
        }

        // --- Transfer Logic ---
        function openTransferModal(userId, username) {
            targetReceiverId = userId;
            document.getElementById('modalTargetUser').innerText = username;
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('transferModal').style.display = 'none'; }

        async function confirmTransfer() {
            const amount = document.getElementById('transferAmount').value;
            const btn = document.querySelector('#transferModal .btn:last-child');
            btn.innerText = "Processing...";

            try {
                // RESTORED: Localhost URL
                const res = await fetch('/api/transfer-credits', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        senderId: currentUser.id,
                        receiverId: targetReceiverId,
                        amount: amount
                    })
                });
                const data = await res.json();
                alert(data.message);
                if(data.success) {
                    closeModal();
                    updateHeader();
                    loadDownline();
                }
            } catch(e) { alert("Server Error"); }
            btn.innerText = "Confirm";
        }

        // --- Create User ---
        function setupRoles() {
            if(currentUser.role === 'Client') { document.getElementById('createCard').style.display='none'; return; }
            const roles = ['Admin','SuperMaster','Master','Agent','Client'];
            const hierarchy = {'SuperAdmin':6,'Admin':5,'SuperMaster':4,'Master':3,'Agent':2,'Client':1};
            const myRank = hierarchy[currentUser.role];
            
            const sel = document.getElementById('newRole');
            roles.forEach(r => {
                if(hierarchy[r] < myRank) {
                    let opt = document.createElement('option');
                    opt.value=r; opt.innerText=r;
                    sel.appendChild(opt);
                }
            });
        }

        document.getElementById('createForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            try {
                // RESTORED: Localhost URL
                const res = await fetch('/api/create-user', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        creatorRole: currentUser.role, creatorId: currentUser.id,
                        newUsername: document.getElementById('newUsername').value,
                        newPassword: document.getElementById('newPassword').value,
                        newRole: document.getElementById('newRole').value
                    })
                });
                const d = await res.json();
                alert(d.message);
                if(d.success) loadDownline();
            } catch(e){ alert("Offline"); }
        });

        // --- UI ---
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('sidebar').classList.remove('show');
        }
        function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('show'); event.stopPropagation(); }
        function closeSidebar(e){ 
            if(window.innerWidth<=768 && !e.target.classList.contains('mobile-toggle')) 
                document.getElementById('sidebar').classList.remove('show'); 
        }
        function logout(){ sessionStorage.removeItem('currentUser'); window.location.href='login.html'; }
    </script>
</body>
</html>