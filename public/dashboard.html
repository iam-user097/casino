<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic9 Pro Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- NEON DARK THEME CORE --- */
        :root { --primary:#00509d; --dark:#011627; --accent:#ffcc00; --neon-g: #39ff14; --neon-r: #ff3131; --bg:#0b0e14; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; transition: background 0.3s, border 0.3s; }
        body { display:flex; height:100vh; background:var(--bg); color: white; overflow:hidden; }

        /* Sidebar Styling */
        .sidebar { width:260px; background:#12161f; border-right:1px solid var(--primary); display:flex; flex-direction:column; z-index:2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 5px 0 15px rgba(0, 80, 157, 0.2); }
        .logo { background:black; padding:20px; text-align:center; color:var(--accent); font-weight:bold; font-size:22px; border-bottom:2px solid var(--primary); text-shadow: 0 0 10px var(--accent); }
        .nav-item { padding:15px 25px; color:#aaa; cursor:pointer; display:flex; align-items:center; gap:10px; border-bottom:1px solid #1a202c; transition: 0.2s ease; }
        .nav-item:hover { color: white; background: rgba(0, 80, 157, 0.1); padding-left: 30px; }
        .nav-item.active { background:linear-gradient(90deg, rgba(0, 80, 157, 0.3), transparent); color:var(--accent); border-left:4px solid var(--accent); font-weight: bold; }

        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1500; backdrop-filter: blur(3px); }
        .main { flex:1; display:flex; flex-direction:column; width:100%; overflow:hidden; position: relative; }
        .header { background:#12161f; color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        .page { display:none; padding:20px; overflow-y:auto; flex:1; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .page.active { display:block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        /* Tables & UI Components */
        .table-container { background: #12161f; border-radius: 8px; overflow-x: auto; margin-top: 10px; border: 1px solid var(--primary); box-shadow: 0 0 20px rgba(0, 80, 157, 0.2); }
        table { width:100%; border-collapse:collapse; background: transparent; color: #eee; min-width: 900px; }
        th { background: #011627; color: var(--accent); padding: 12px; font-size: 13px; text-transform: capitalize; border-bottom: 1px solid var(--primary); text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #1a202c; text-align: center; font-weight: 500; font-size: 13px; vertical-align: middle; }

        .act-btn { width: 30px; height: 30px; border-radius: 50%; border: none; color: white; cursor: pointer; margin: 0 2px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }
        .btn-edit { background: #007bff; } .btn-d { background: var(--primary); } .btn-w { background: #6c757d; } .btn-del { background: var(--neon-r); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .modal-content { background:#12161f; color:white; width:90%; max-width:650px; border-radius:12px; overflow:hidden; border: 1px solid var(--primary); animation: zoomIn 0.3s; }
        .modal-header { background:#011627; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid var(--neon-r); color: var(--accent); }
        .modal-body { padding:25px; display:grid; grid-template-columns: 1fr 1fr; gap:20px; max-height: 80vh; overflow-y: auto; }
        .form-group { display:flex; flex-direction:column; gap:8px; }
        .form-group label { font-size: 13px; font-weight: bold; color: var(--accent); }
        .form-group input, .form-group select { padding: 12px; border: 1px solid #333; border-radius: 6px; background: #0b0e14; color: white; outline: none; }

        .account-card { background:linear-gradient(145deg, #12161f, #011627); border-radius:15px; padding:25px; text-align:center; margin-bottom:15px; border:1px solid var(--primary); }
        .neon-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .neon-box { padding:15px; border-radius:12px; font-weight:bold; text-align:center; font-size:14px; text-transform: uppercase; background: #0b0e14; border: 2px solid #333; }
        .win-box { border-color: var(--neon-g); color: var(--neon-g); }
        .lose-box { border-color: var(--neon-r); color: var(--neon-r); }

        /* Betting Styles */
        .bet-header-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #12161f; padding: 15px; border-radius: 10px; border: 1px solid var(--primary); text-align: center; }
        .odds-buttons button { background: #72bbef; border: none; height: 35px; border-radius: 4px; font-weight: bold; cursor: pointer; color: black; transition: 0.2s; }
        .odds-buttons button:last-child { background: #faa9ba; }

        @keyframes flash-green { 0% { background-color: #72bbef; } 50% { background-color: #39ff14; } 100% { background-color: #72bbef; } }
        @keyframes flash-red { 0% { background-color: #faa9ba; } 50% { background-color: #ff3131; } 100% { background-color: #faa9ba; } }
        .odds-up { animation: flash-green 0.5s ease; }
        .odds-down { animation: flash-red 0.5s ease; }

        @keyframes zoomIn { from { transform:scale(0.8); opacity:0; } to { transform:scale(1); opacity:1; } }
        @media(max-width:768px) { .sidebar { position:fixed; left:0; transform: translateX(-100%); } .sidebar.show { transform: translateX(0); } .sidebar-overlay.show { display: block; } }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="logo">Magic9.pro</div>
        <div class="nav-item active" onclick="nav('user', this)"><i class="fa-regular fa-user"></i> User Management</div>
        <div class="nav-item" onclick="nav('bet', this)"><i class="fas fa-dice"></i> Live Betting</div>
        <div class="nav-item" onclick="nav('history', this)"><i class="fas fa-history"></i> History</div>
        <div class="nav-item" onclick="nav('account', this)"><i class="fas fa-user-circle"></i> My Account</div>
        <div class="nav-item" style="margin-top:auto; color:var(--neon-r)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>

    <div class="main">
        <div class="header">
            <div style="display:flex; align-items:center;"><i class="fas fa-bars mobile-toggle" style="display:none;" onclick="toggleSidebar(event)"></i><h3 style="margin-left: 10px;">Dashboard</h3></div>
            <div id="headerBal" style="font-weight:bold; color:var(--accent); border: 1px solid var(--accent); padding: 5px 15px; border-radius: 50px;">ðŸª™ Loading...</div>
        </div>

        <div id="page-user" class="page active">
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
                <input type="text" id="userSearch" onkeyup="filterUsers()" placeholder="Search User..." style="padding:10px; width:300px; border-radius:6px; background:#12161f; border:1px solid #333; color:white;">
                <button id="addBtn" style="background:var(--primary); padding:10px 20px; border-radius:6px; border:none; color:white;" onclick="openModal()">+ Add User</button>
            </div>
            <div class="table-container">
                <table id="userTable">
                    <thead><tr><th>In</th><th>Name</th><th>Exposure</th><th>Settlement</th><th>Points</th><th>Login</th><th>Lock</th><th>Active</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="page-bet" class="page">
            <div class="bet-header-stats">
                <div class="stat-box"><span>Main Balance</span><h2 id="wallet-val" style="color:var(--accent);">â‚¹ 0</h2></div>
                <div class="stat-box"><span>Liability</span><h2 id="exposure-val" style="color:var(--neon-r);">0</h2></div>
            </div>
            <div class="market-section" style="background:#12161f; border-radius:8px; border:1px solid #1a202c;">
                <div style="background:var(--primary); padding:10px; font-weight:bold;">CRICKET IN-PLAY</div>
                <div class="event-row" style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #1a202c;">
                    <div><strong>India U19 v Bangladesh U19</strong><br><small style="color:var(--neon-g);">Live Now</small></div>
                    <div class="odds-buttons" style="display:grid; grid-template-columns: 55px 55px; gap:5px;">
                        <button onclick="openBetSlip('India U19', 1.33)">1.33</button>
                        <button onclick="openBetSlip('India U19', 1.34)">1.34</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="betSlip" class="modal" style="align-items:flex-end;">
            <div class="modal-content" style="width:100%; max-width:100%; border-radius:20px 20px 0 0; border-top:4px solid var(--accent);">
                <div class="modal-header"><h3 id="slipTeam">Place Bet</h3><i class="fas fa-times-circle" style="color:red; cursor:pointer;" onclick="closeBetSlip()"></i></div>
                <div class="modal-body" style="grid-template-columns: 1fr;">
                    <div style="display:flex; justify-content:space-between; padding:15px; background:#0b0e14; border-radius:8px;">
                        <span>Odds: <strong id="slipOdds">1.00</strong></span>
                        <input type="number" id="betAmount" value="100" min="100" style="width:100px; text-align:right;">
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
                        <button class="neon-box" style="cursor:pointer;" onclick="setStake(100)">100</button>
                        <button class="neon-box" style="cursor:pointer;" onclick="setStake(500)">500</button>
                        <button class="neon-box" style="cursor:pointer;" onclick="setStake(1000)">1k</button>
                        <button class="neon-box" style="cursor:pointer;" onclick="setStake(5000)">5k</button>
                    </div>
                    <button id="confirmBetBtn" onclick="confirmBet()" style="background:var(--neon-g); color:black; font-weight:bold; padding:15px; border-radius:8px; border:none; width:100%; font-size:16px;">CONFIRM BET</button>
                </div>
            </div>
        </div>

        <div id="page-history" class="page">
            <div class="table-container">
                <table id="histTable">
                    <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Details</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="page-account" class="page">
            <div class="account-card">
                <p>TOTAL BALANCE</p>
                <h1 style="color:var(--accent);">â‚¹ <span id="inr">0</span></h1>
                <p>Chips: <span id="chips">0</span></p>
            </div>
            <div class="neon-grid">
                <div class="neon-box win-box">WINNINGS<br><span id="wins">0</span></div>
                <div class="neon-box lose-box">LOSSES<br><span id="lose">0</span></div>
            </div>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="mTitle">Add User</h3><i class="fas fa-times-circle" onclick="closeModal()"></i></div>
            <div class="modal-body">
                <div class="form-group"><label>First Name*</label><input type="text" id="mFName" required></div>
                <div class="form-group"><label>Username*</label><input type="text" id="mUName" required></div>
                <div class="form-group" id="passDiv"><label>Password*</label><input type="password" id="mPass"></div>
                <div class="form-group" id="roleDiv"><label>Role*</label><select id="mRole"></select></div>
                <div class="form-group" id="depoDiv"><label>Deposit*</label><input type="number" id="mDeposit"></div>
            </div>
            <div class="modal-footer">
                <button class="act-btn" style="width:auto; padding:5px 15px; background:var(--neon-r);" onclick="closeModal()">Cancel</button>
                <button class="act-btn" style="width:auto; padding:5px 15px; background:var(--neon-g); color:black;" onclick="submitUser()">Submit</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. STATE & DATA ---
    let user = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!user) window.location.href = 'login.html';
    let activeBetData = null;

    // Commission % from Profit (As requested)
    const COMMISSION_RATES = {
        'SuperAdmin': 0.10, 'Admin': 0.08, 'SuperMaster': 0.06,
        'Master': 0.05, 'Agent': 0.04, 'Client': 0.00
    };

    // --- 2. INITIALIZATION ---
    async function init() {
        try {
            const res = await fetch('/api/user-details', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: user.id})
            });
            const d = await res.json();
            if (d.success) {
                user = d.data;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                updateAllUISlots();
            }
        } catch (e) { console.error("Init Error", e); }
        
        if (user.role !== 'Client') loadUsers();
        setupRoles();
        loadHistory();
        startOddsSimulation();
    }

    function updateAllUISlots() {
        const bal = Number(user.balance || 0);
        const exp = Number(user.exposure || 0);
        const inrBal = Number(user.inr_balance || 0);

        const setUI = (id, val) => { 
            const el = document.getElementById(id);
            if(el) el.innerText = val; 
        };
        
        setUI('headerBal', `ðŸª™ ${bal.toLocaleString()}`);
        setUI('wallet-val', `â‚¹ ${bal.toLocaleString()}`);
        setUI('exposure-val', `-${exp.toLocaleString()}`);
        setUI('inr', inrBal.toLocaleString());
        setUI('chips', bal.toLocaleString());
        setUI('wins', (user.total_wins || 0).toLocaleString());
        setUI('lose', (user.total_losses || 0).toLocaleString());
    }

    // --- 3. BETTING ENGINE ---
    function openBetSlip(team, odds) {
        activeBetData = { team, odds: parseFloat(odds), type: 'back' };
        document.getElementById('slipTeam').innerText = `${team} (BACK)`;
        document.getElementById('slipOdds').innerText = odds.toFixed(2);
        document.getElementById('betSlip').style.display = 'flex';
    }

    function closeBetSlip() { document.getElementById('betSlip').style.display = 'none'; }
    function setStake(amt) { document.getElementById('betAmount').value = amt; }

    async function confirmBet() {
        const amt = parseInt(document.getElementById('betAmount').value);
        if (isNaN(amt) || amt < 100) return alert("Minimum bet is 100");
        if (Number(user.balance) < amt) return alert("Insufficient Balance");

        const btn = document.getElementById('confirmBetBtn');
        const oldTxt = btn.innerText;
        btn.innerText = "PROCESSING...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/place-bet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId: user.id, betAmount: amt, team: activeBetData.team, odds: activeBetData.odds})
            });
            const d = await res.json();

            if (d && d.success) {
                closeBetSlip();
                showResultToast("Bet Placed! Result in 6s...", "win");
                
                // Temporary local update
                user.balance = Number(user.balance) - amt;
                user.exposure = Number(user.exposure) + amt;
                updateAllUISlots();

                // 6s Delay resolution
                setTimeout(() => resolveBetSimulated(amt, activeBetData.odds), 6000);
            } else {
                alert(d ? d.message : "Failed to place bet");
            }
        } catch (e) { alert("Connection Error"); }
        finally { btn.innerText = oldTxt; btn.disabled = false; }
    }

    async function resolveBetSimulated(amt, odds) {
        const isWin = Math.random() > 0.5;
        const netProfit = amt * (odds - 1);

        if (isWin) {
            user.balance = Number(user.balance) + amt + netProfit;
            user.exposure = Number(user.exposure) - amt;
            user.total_wins = (Number(user.total_wins) || 0) + netProfit;
            showResultToast(`WON! +â‚¹${netProfit.toFixed(2)}`, "win");
            distributeCommissions(netProfit);
        } else {
            user.exposure = Number(user.exposure) - amt;
            user.total_losses = (Number(user.total_losses) || 0) + amt;
            showResultToast(`LOST! -â‚¹${amt}`, "loss");
        }
        
        // Sync result to server
        await fetch('/api/update-balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                id: user.id, 
                balance: user.balance, 
                exposure: user.exposure,
                history: { type: isWin ? "WIN" : "LOSS", amount: isWin ? netProfit : -amt, details: `Result for ${activeBetData.team}` }
            })
        });

        updateAllUISlots();
        init(); 
    }

    function distributeCommissions(profit) {
        Object.entries(COMMISSION_RATES).forEach(([role, rate]) => {
            if (rate > 0) {
                const comm = profit * rate;
                fetch('/api/distribute-commission', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({role, amount: comm, fromId: user.id})
                }).catch(e => console.log("Comm Sync Error"));
            }
        });
    }

    // --- 4. VISUALS & ODDS ---
    function startOddsSimulation() {
        setInterval(() => {
            const btn = document.querySelector('.odds-buttons button:nth-child(1)');
            if (!btn) return;
            const oldVal = parseFloat(btn.innerText);
            const change = (Math.random() * 0.04 - 0.02);
            const newVal = Math.max(1.01, oldVal + change).toFixed(2);
            btn.innerText = newVal;
            btn.classList.remove('odds-up', 'odds-down');
            void btn.offsetWidth;
            btn.classList.add(change >= 0 ? 'odds-up' : 'odds-down');
        }, 4000);
    }

    function showResultToast(msg, type) {
        const toast = document.createElement('div');
        toast.className = `result-toast toast-${type}`;
        toast.style.cssText = `position:fixed; top:20px; right:20px; padding:15px; border-radius:8px; z-index:9999; font-weight:bold; background:${type==='win'?'#39ff14':'#ff3131'}; color:#000; box-shadow: 0 0 10px rgba(0,0,0,0.5);`;
        toast.innerText = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // --- 5. SYSTEM FUNCTIONS ---
    function nav(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.getElementById('overlay').classList.toggle('show');
    }

    async function loadUsers() {
        const tbody = document.querySelector('#userTable tbody');
        if(!tbody) return;
        try {
            const res = await fetch('/api/my-users', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({parentId: user.id, role: user.role})
            });
            const d = await res.json();
            tbody.innerHTML = d.users.map(u => `
                <tr>
                    <td><i class="fas fa-arrow-circle-right" style="color:var(--neon-r);"></i></td>
                    <td>${u.username} (${u.role})</td>
                    <td style="color:var(--neon-g)">${u.exposure}</td>
                    <td>0</td>
                    <td style="color:var(--accent)">${u.balance}</td>
                    <td><label class="switch"><input type="checkbox" disabled><span class="slider"></span></label></td>
                    <td><label class="switch"><input type="checkbox"><span class="slider"></span></label></td>
                    <td><label class="switch"><input type="checkbox" disabled><span class="slider"></span></label></td>
                    <td><button class="act-btn btn-edit"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');
        } catch(e) {}
    }

    async function loadHistory() {
        const tbody = document.querySelector('#histTable tbody');
        if(!tbody) return;
        try {
            const res = await fetch('/api/history', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId: user.id})
            });
            const d = await res.json();
            tbody.innerHTML = d.history.map(h => `
                <tr><td>${new Date(h.created_at).toLocaleString()}</td><td>${h.type}</td><td style="color:${h.amount >= 0 ? 'var(--neon-g)' : 'var(--neon-r)'}">${h.amount}</td><td>${h.description}</td></tr>
            `).join('');
        } catch(e) {}
    }

    function setupRoles() {
        const roles = ['Admin', 'SuperMaster', 'Master', 'Agent', 'Client'];
        const h = { 'SuperAdmin': 6, 'Admin': 5, 'SuperMaster': 4, 'Master': 3, 'Agent': 2, 'Client': 1 };
        const sel = document.getElementById('mRole');
        if (sel && sel.options.length === 0) {
            roles.forEach(r => { if (h[r] < h[user.role]) sel.innerHTML += `<option value="${r}">${r}</option>`; });
        }
    }

    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function openModal() { document.getElementById('userModal').style.display = 'flex'; }
    function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

    init();
</script>
</body>
</html>
