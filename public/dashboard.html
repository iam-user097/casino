<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic9 Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS --- */
        :root { --primary:#00509d; --dark:#002952; --accent:#ffcc00; --bg:#f2f4f8; --danger: #dc3545; --success: #28a745; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { display:flex; height:100vh; background:var(--bg); overflow:hidden; }

        /* Sidebar */
        .sidebar { width:260px; background:white; border-right:1px solid #ddd; display:flex; flex-direction:column; z-index:1000; transition:0.3s; }
        .logo-area { background:black; padding:25px; text-align:center; color:var(--accent); font-weight:800; border-bottom:4px solid var(--primary); font-size: 20px; }
        .nav-item { padding:16px 25px; color:#555; display:flex; align-items:center; border-bottom:1px solid #f9f9f9; cursor:pointer; transition: 0.2s; }
        .nav-item:hover { background: #f8f9fa; }
        .nav-item.active { background:#eef7ff; color:var(--primary); border-left:4px solid var(--primary); }
        .nav-item i { width:25px; margin-right:10px; }
        
        /* Main Content */
        .main-content { flex:1; display:flex; flex-direction:column; width:100%; position: relative; }
        .top-header { background:linear-gradient(90deg, var(--primary), var(--dark)); color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .user-pill { background:rgba(255,255,255,0.15); padding:6px 15px; border-radius:50px; border:1px solid rgba(255,255,255,0.2); font-weight:bold; font-size:13px; display: flex; align-items: center; gap: 8px; }

        /* Pages & Cards */
        .page { display:none; padding:15px; overflow-y:auto; flex:1; animation:slideUp 0.4s ease; }
        .page.active { display:block; }
        @keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        .card { background:white; border-radius:12px; padding:20px; margin-bottom:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); border-top:4px solid var(--primary); }
        .card h3 { font-size: 16px; margin-bottom: 15px; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        
        .btn { padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:active { transform: scale(0.96); }
        .btn-danger { background: var(--danger); }
        
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; outline:none; margin-top:5px; background: #fff; }

        /* User Table */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; }
        table { width:100%; border-collapse:collapse; font-size:13px; min-width: 500px; }
        th { background:#f8f9fa; text-align:left; padding:12px; color: #666; font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding:12px; border-bottom:1px solid #eee; vertical-align: middle; }
        .status-dot { height:8px; width:8px; border-radius:50%; display:inline-block; margin-right:5px; }
        
        /* Modal Styles */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content:center; align-items:center; z-index:2000; padding: 20px; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:100%; max-width:350px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

        /* Footer Badges */
        .footer { text-align:center; padding:20px; font-size:11px; color:#888; background:white; }
        .badges { display:flex; justify-content:center; gap:8px; margin-bottom:10px; flex-wrap: wrap; }
        .badge { border:1px solid #ddd; padding:4px 8px; border-radius:4px; font-size:10px; display:flex; align-items:center; gap:4px; font-weight: 600; }

        /* Responsive Mobile UI */
        @media(max-width:768px) { 
            .sidebar { position:fixed; left:-260px; height:100%; box-shadow: none; }
            .sidebar.show { left:0; box-shadow:5px 0 20px rgba(0,0,0,0.3); }
            .mobile-toggle { display:block !important; font-size:22px; cursor: pointer; }
            .page { padding: 10px; }
            .card { padding: 15px; }
            .user-pill { font-size: 12px; padding: 5px 10px; }
        }
        .mobile-toggle { display:none; }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="logo-area">Magic9.pro</div>
        <div class="nav-item active" onclick="nav('user', this)"><i class="fas fa-users"></i> User Management</div>
        <div class="nav-item" onclick="nav('bets', this)"><i class="fas fa-gamepad"></i> Live Betting</div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger);" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="top-header">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar(event)"></i>
                <h3 style="font-size: 18px;">Dashboard</h3>
            </div>
            <div class="user-pill" id="headerUser">
                <i class="fas fa-circle-notch fa-spin"></i> Loading
            </div>
        </div>

        <div id="page-user" class="page active">
            <div class="card" id="createCard">
                <h3><i class="fas fa-user-plus" style="color: var(--primary);"></i> Create Downline</h3>
                <form id="createForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #666;">Role</label>
                            <select id="newRole"></select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Username</label>
                            <input type="text" id="newUsername" placeholder="Enter user" required>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="font-size: 12px; color: #666;">Password</label>
                        <input type="text" id="newPassword" placeholder="Set password" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%; margin-top: 15px;">Create New User</button>
                </form>
            </div>

            <div class="card">
                <h3><i class="fas fa-list" style="color: var(--primary);"></i> User Activity List</h3>
                <div class="table-container">
                    <table id="userTable">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>User</th>
                                <th>Role</th>
                                <th>Chips</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align:center; padding: 30px;">Initializing...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-bets" class="page">
            <div class="card">
                <h3><i class="fas fa-play-circle" style="color: var(--primary);"></i> Live Matches</h3>
                <div style="text-align: center; padding: 40px 20px; color: #888;">
                    <i class="fas fa-clock fa-3x" style="margin-bottom: 15px; opacity: 0.3;"></i>
                    <p>Betting module is currently in Demo mode.</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="badges">
                <div class="badge" style="color:red; border-color:red"><i class="fas fa-ban"></i> 18+ Only</div>
                <div class="badge" style="color:green; border-color:green"><i class="fas fa-shield-alt"></i> Secure</div>
                <div class="badge" style="color:blue; border-color:blue"><i class="fas fa-headset"></i> Support</div>
            </div>
            &copy; 2026 Magic9.pro. All Rights Reserved.
        </div>
    </div>

    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-bottom: 5px;">Manage Chips</h3>
            <p style="margin-bottom: 20px; font-size:14px; color: #666;">Transferring to: <b id="modalTargetUser" style="color: #000;"></b></p>
            <input type="number" id="transferAmount" placeholder="0.00" style="text-align:center; font-size:22px; font-weight: bold; color: var(--primary);">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-danger" style="flex:1" onclick="closeModal()">Cancel</button>
                <button class="btn" style="flex:1" onclick="confirmTransfer()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let targetReceiverId = null;

        // Secure Initialization
        try { 
            currentUser = JSON.parse(sessionStorage.getItem('currentUser')); 
        } catch(e) { console.error("Session error"); }
        
        if(!currentUser) window.location.href = 'login.html';

        init();

        function init() {
            updateHeader();
            setupRoles();
            loadDownline();
            
            // Close sidebar when clicking outside on mobile
            document.getElementById('mainContent').addEventListener('click', () => {
                if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('show');
            });
        }

        async function updateHeader() {
            try {
                const res = await fetch('/api/user-details', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({id: currentUser.id})
                });
                const data = await res.json();
                if(data.success) {
                    currentUser = data.data;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('headerUser').innerHTML = `
                        <span>${currentUser.username}</span>
                        <span style="color:var(--accent); border-left: 1px solid rgba(255,255,255,0.3); padding-left: 8px;">
                            <i class="fas fa-coins"></i> ${parseFloat(currentUser.balance).toLocaleString()}
                        </span>
                    `;
                }
            } catch(e) { document.getElementById('headerUser').innerText = "Offline"; }
        }

        async function loadDownline() {
            const tbody = document.querySelector('#userTable tbody');
            try {
                const res = await fetch('/api/my-users', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({parentId: currentUser.id})
                });
                const data = await res.json();
                tbody.innerHTML = '';
                
                if(!data.users || data.users.length === 0) { 
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No downline users found.</td></tr>'; 
                    return; 
                }

                data.users.forEach(u => {
                    const statusColor = u.status === 'Online' ? 'var(--success)' : 'var(--danger)';
                    const isSuperAdmin = currentUser.role === 'SuperAdmin';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="status-dot" style="background:${statusColor}; box-shadow: 0 0 5px ${statusColor}"></span> ${u.status}</td>
                            <td><b>${u.username}</b></td>
                            <td><span style="font-size:11px; background:#eee; padding:2px 6px; border-radius:4px;">${u.role}</span></td>
                            <td style="color:var(--primary); font-weight:bold;">${parseFloat(u.balance).toLocaleString()}</td>
                            <td>
                                <div style="display:flex; gap:5px;">
                                    <button class="btn" style="padding:6px 10px; font-size:11px;" onclick="openTransferModal(${u.id}, '${u.username}')">
                                        <i class="fas fa-plus"></i> Give
                                    </button>
                                    ${isSuperAdmin ? `
                                        <button class="btn btn-danger" style="padding:6px 10px; font-size:11px;" onclick="takeBackChips(${u.id}, '${u.username}')">
                                            <i class="fas fa-undo"></i> Take
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="5">Connection Error</td></tr>'; }
        }

        // --- Chip Management Logic ---
        function openTransferModal(userId, username) {
            targetReceiverId = userId;
            document.getElementById('modalTargetUser').innerText = username;
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('transferModal').style.display = 'none'; }

        async function confirmTransfer() {
            const amount = document.getElementById('transferAmount').value;
            if(!amount || amount <= 0) return alert("Enter valid amount");

            try {
                const res = await fetch('/api/transfer-credits', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        senderId: currentUser.id,
                        receiverId: targetReceiverId,
                        amount: amount
                    })
                });
                const data = await res.json();
                if(data.success) {
                    closeModal();
                    updateHeader();
                    loadDownline();
                } else {
                    alert(data.message);
                }
            } catch(e) { alert("Server error"); }
        }

        async function takeBackChips(userId, username) {
            if(!confirm(`Are you sure you want to take back all remaining chips from ${username}?`)) return;

            try {
                const res = await fetch('/api/take-back-chips', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({ adminId: currentUser.id, userId: userId })
                });
                const data = await res.json();
                if(data.success) {
                    alert(`Recovered ${data.recovered} chips!`);
                    updateHeader();
                    loadDownline();
                }
            } catch(e) { alert("Action failed"); }
        }

        // --- User Creation ---
        function setupRoles() {
            const roles = ['Admin','SuperMaster','Master','Agent','Client'];
            const hierarchy = {'SuperAdmin':6,'Admin':5,'SuperMaster':4,'Master':3,'Agent':2,'Client':1};
            const myRank = hierarchy[currentUser.role] || 0;
            
            if(myRank <= 1) document.getElementById('createCard').style.display='none';
            
            const sel = document.getElementById('newRole');
            roles.forEach(r => {
                if(hierarchy[r] < myRank) {
                    let opt = document.createElement('option');
                    opt.value=r; opt.innerText=r;
                    sel.appendChild(opt);
                }
            });
        }

        document.getElementById('createForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const res = await fetch('/api/create-user', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    creatorId: currentUser.id,
                    newUsername: document.getElementById('newUsername').value,
                    newPassword: document.getElementById('newPassword').value,
                    newRole: document.getElementById('newRole').value
                })
            });
            const d = await res.json();
            alert(d.message);
            if(d.success) {
                document.getElementById('createForm').reset();
                loadDownline();
            }
        });

        // --- UI Navigation ---
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('sidebar').classList.remove('show');
        }

        function toggleSidebar(e){ 
            e.stopPropagation();
            document.getElementById('sidebar').classList.toggle('show'); 
        }

        function logout(){ 
            sessionStorage.removeItem('currentUser'); 
            window.location.href='login.html'; 
        }
    </script>
</body>
</html>
